angular.module("windmobile.controllers",["windmobile.services"]).controller("ListController",["$scope","$state","$http","$interval","utils",function(t,o,e,a,n){function i(t){var o={proj:["short","loc","status","prov","alt","last._id","last.w-dir","last.w-avg","last.w-max"]};t&&(o["near-lat"]=t.coords.latitude,o["near-lon"]=t.coords.longitude),o.search=r.search,o.limit=12,e({method:"GET",url:"/api/2/stations/",params:o}).success(function(t){r.stations=t;for(var o=0;o<r.stations.length;o++){var e=r.stations[o];e.fromNow=moment.unix(e.last._id).fromNow();var a=n.getStationStatus(e);e.fromNowClass=n.getStatusClass(a),r.getHistoric(e)}})}var r=this;this.getHistoric=function(t){var o={duration:3600,proj:["w-dir","w-avg"]};e({method:"GET",url:"/api/2/stations/"+t._id+"/historic",params:o}).success(function(o){var e={data:o};t.historic=e})},this.selectStation=function(t){o.go("list.detail",{stationId:t._id})},this.doSearch=function(){if(navigator.geolocation){var t=setTimeout(i,1e3);navigator.geolocation.getCurrentPosition(function(o){clearTimeout(t),i(o)},function(o){clearTimeout(t),i()},{enableHighAccuracy:!0,maximumAge:3e5})}else i()},this.clearSearch=function(){this.search=null,this.doSearch()},t.onFromNowInterval=function(){for(var t=0;t<r.stations.length;t++){var o=r.stations[t];o.fromNow=moment.unix(o.last._id).fromNow();var e=n.getStationStatus(o);o.fromNowClass=n.getStatusClass(e)}},t.onRefreshInterval=function(){r.doSearch()},t.$on("$stateChangeStart",function(o,e,i,r,s){"list"===e.name?(t.fromNowInterval=a(t.onFromNowInterval,n.fromNowInterval),t.refreshInterval=a(t.onRefreshInterval,n.refreshInterval)):"list"===r.name&&(a.cancel(t.fromNowInterval),a.cancel(t.refreshInterval)),$("#detailModal").modal("hide")}),t.fromNowInterval=a(t.onFromNowInterval,n.fromNowInterval),t.refreshInterval=a(t.onRefreshInterval,n.refreshInterval),this.doSearch()}]).controller("MapController",["$scope","$state","$http","$compile","$templateCache","$interval","utils",function(t,o,e,a,n,i,r){function s(t){for(var o=0;o<f.length;o++){var e=f[o];if(e.station._id===t)return e}return null}function l(t,o){for(var e=0;e<o.length;e++)if(o[e]._id===t)return!0;return!1}function c(t){for(var o=0;o<f.length;o++){var e=f[o];l(e.station._id,t)||(google.maps.event.clearInstanceListeners(e),e.setMap(null),f.splice(o,1),o--)}for(o=0;o<t.length;o++){var a=t[o],e=s(a._id);if(h.selectedStation&&h.selectedStation._id===a._id){h.selectedStation=a,h.selectedStation.fromNow=moment.unix(h.selectedStation.last._id).fromNow();var n=r.getStationStatus(h.selectedStation);h.selectedStation.fromNowClass=r.getStatusClass(n),h.getHistoric()}var i;i=0==r.getStationStatus(a)?"#808080":r.getColorInRange(a.last["w-max"],50);var c={path:"M21,149.2v86.3L-19,213l50,77l50-77l-40,22.5v-86.3c28.4-4.8,50-29.4,50-59.2S69.4,35.6,41,30.8V-83H21V30.8C-7.4,35.6-29,60.3-29,90S-7.4,144.4,21,149.2z M31,50c22.1,0,40,17.9,40,40s-17.9,40-40,40S-9,112.1-9,90S8.9,50,31,50z",anchor:new google.maps.Point(31,90),scale:.12,fillOpacity:1,fillColor:i,strokeColor:i,strokeWeight:2,rotation:a.last?a.last["w-dir"]:0};e?e.setIcon(c):(e=new google.maps.Marker({title:a["short"],position:new google.maps.LatLng(a.loc.coordinates[1],a.loc.coordinates[0]),icon:c,map:h.map}),e.station=a,f.push(e),google.maps.event.addListener(e,"click",function(){this.timeout||(e=this,this.timeout=setTimeout(function(){e.timeout=null,u&&u.close(),h.selectedStation=e.station,h.selectedStation.fromNow=moment.unix(h.selectedStation.last._id).fromNow();var t=r.getStationStatus(h.selectedStation);h.selectedStation.fromNowClass=r.getStatusClass(t),h.getHistoric(),u=new InfoBox({content:d[0],closeBoxURL:""}),u.open(h.map,e)},300))}),google.maps.event.addListener(e,"dblclick",function(t){throw clearTimeout(this.timeout),this.timeout=null,"propagates dblclick event"}))}}function m(t){var o={proj:["short","loc","status","prov","alt","last._id","last.w-dir","last.w-avg","last.w-max"]};t&&(o["within-pt1-lat"]=t.getNorthEast().lat(),o["within-pt1-lon"]=t.getNorthEast().lng(),o["within-pt2-lat"]=t.getSouthWest().lat(),o["within-pt2-lon"]=t.getSouthWest().lng()),o.search=h.search,o.limit=100,e({method:"GET",url:"/api/2/stations/",params:o}).success(c)}var u,d=a(n.get("_infobox.html"))(t),h=this,f=[];this.getHistoric=function(){var t={duration:3600,proj:["w-dir","w-avg"]};e({method:"GET",url:"/api/2/stations/"+h.selectedStation._id+"/historic",params:t}).success(function(t){var o={data:t};h.selectedStation.historic=o})},this.selectStation=function(){u&&u.close(),o.go("map.detail",{stationId:this.selectedStation._id})},this.doSearch=function(){m(this.map.getBounds())},this.clearSearch=function(){this.search=null,this.doSearch()},this.centerMap=function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){var o=new google.maps.LatLng(t.coords.latitude,t.coords.longitude);h.map.panTo(o),h.map.setZoom(8)},null,{enableHighAccuracy:!0,maximumAge:3e5})};var g={center:new google.maps.LatLng(46.76,4.08),zoom:6,panControl:!1,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.TERRAIN,google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE]},mapTypeId:google.maps.MapTypeId.TERRAIN};this.map=new google.maps.Map(document.getElementById("map-canvas"),g),google.maps.event.addListener(h.map,"click",function(){u&&(u.close(),h.selectedStation=null)}),google.maps.event.addListener(h.map,"bounds_changed",function(){var t;return function(){clearTimeout(t),t=setTimeout(function(){h.doSearch()},500)}}()),t.onFromNowInterval=function(){if(h.selectedStation){h.selectedStation.fromNow=moment.unix(h.selectedStation.last._id).fromNow();var t=r.getStationStatus(h.selectedStation);h.selectedStation.fromNowClass=r.getStatusClass(t)}},t.onRefreshInterval=function(){h.doSearch(),h.selectedStation&&h.getHistoric()},t.$on("$stateChangeStart",function(o,e,a,n,s){"map"===e.name?(t.fromNowInterval=i(t.onFromNowInterval,r.fromNowInterval),t.refreshInterval=i(t.onRefreshInterval,r.refreshInterval)):"map"===n.name&&(i.cancel(t.fromNowInterval),i.cancel(t.refreshInterval)),$("#detailModal").modal("hide")}),t.fromNowInterval=i(t.onFromNowInterval,r.fromNowInterval),t.refreshInterval=i(t.onRefreshInterval,r.refreshInterval),this.centerMap()}]).controller("DetailController",["$scope","$state","$stateParams","$http","$interval","utils",function(t,o,e,a,n,i){var r=this;$("#detailModal").modal().on("hidden.bs.modal",function(t){o.go("^")}),$('a[data-target="#tab2"]').on("shown.bs.tab",function(t){var o={duration:432e3,proj:["w-dir","w-avg","w-max"]};a({method:"GET",url:"/api/2/stations/"+e.stationId+"/historic",params:o}).success(function(t){r.stationWindChart=t})}),$('a[data-target="#tab3"]').on("shown.bs.tab",function(t){var o={duration:432e3,proj:["temp","hum","rain"]};a({method:"GET",url:"/api/2/stations/"+e.stationId+"/historic",params:o}).success(function(t){r.stationAirChart=t})}),this.getStation=function(){a({method:"GET",url:"/api/2/stations/"+e.stationId}).success(function(t){r.station=t,r.station.fromNow=moment.unix(r.station.last._id).fromNow();var o=i.getStationStatus(r.station);r.station.fromNowClass=i.getStatusClass(o)})},this.getStationHistoric=function(){var t={duration:3600,proj:["w-dir","w-avg","w-max"]};a({method:"GET",url:"/api/2/stations/"+e.stationId+"/historic",params:t}).success(function(t){var o={data:t},e=function(t){return t["w-avg"]},a=function(t){return t["w-max"]};o.lastHour={},o.lastHour.min=Math.min.apply(null,t.map(e)),o.lastHour.mean=t.map(e).reduce(function(t,o){return t+o},0)/t.length,o.lastHour.max=Math.max.apply(null,t.map(a)),r.stationHistoric=o})},this.doDetail=function(){this.getStation(),this.getStationHistoric()},t.onFromNowInterval=function(){r.station.fromNow=moment.unix(r.station.last._id).fromNow();var t=i.getStationStatus(r.station);r.station.fromNowClass=i.getStatusClass(t)},t.onRefreshInterval=function(){r.doDetail()},t.$on("$stateChangeStart",function(o,e,a,r,s){e.name.indexOf("detail")>-1?(t.fromNowInterval=n(t.onFromNowInterval,i.fromNowInterval),t.refreshInterval=n(t.onRefreshInterval,i.refreshInterval)):r.name.indexOf("detail")>-1&&(n.cancel(t.fromNowInterval),n.cancel(t.refreshInterval))}),t.fromNowInterval=n(t.onFromNowInterval,i.fromNowInterval),t.refreshInterval=n(t.onRefreshInterval,i.refreshInterval),this.doDetail()}]);